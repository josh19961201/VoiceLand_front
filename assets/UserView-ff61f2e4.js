import{B as M,C as O,S as w,T as R,a5 as S,a0 as N,L as $,P as A,F as G,K as H,a6 as L}from"./router-079c6ebf.js";import{aL as K,G as v,j as b,o as W,K as Z,aD as F,aE as h,N as a,M as t,h as I,aM as _,aQ as Q,O as J}from"./plugin-vueexport-helper-7abb35e5.js";import{N as X,a as Y}from"./headers-04aa7c74.js";import{_ as T}from"./DataTable-ad652812.js";import{_ as ee}from"./FormItemGridItem-2a2f8f39.js";import{e as ae}from"./Button-4159ae6a.js";import"./vue-router-23be1caa.js";import"./Icon-085b31e9.js";import"./light-1cb1544e.js";const te={class:"container"},se={class:"inside"},ne={class:"btnGroup"},oe={class:"btnGroup"},re={__name:"UserView",setup(le){const m=M(),P=O(),k=v([]),o=v({name:"",email:"",mobilephone:"",address:""}),i=v({originalPassword:"",newPassword:"",passwordConfirm:""}),x=b(null),C=b(null),c=b(!1);(async()=>{var n,e;try{const s=await w.get("/users/me");Object.assign(o,s.data.result);const{data:u}=await w.get("/orders");k.push(...u.result.map((r,d)=>(r.totalPrice="$"+r.products.reduce((p,f)=>p+f.p_id.price*f.quantity,0),r.key=d+1,r.date=new Date(r.date).toLocaleDateString(),r)))}catch(s){m.error({title:"失敗",content:((e=(n=s==null?void 0:s.response)==null?void 0:n.data)==null?void 0:e.message)||"取得資料失敗",positiveText:"再試一次"})}})();const q={email:{required:!0,validator(n,e){if(e){if(!N.isEmail(e))return new Error("Email格式錯誤")}else return new Error("請輸入Email");return!0},trigger:["input","blur"]},mobilephone:{validator(n,e){return e&&!N.isMobilePhone(e,"zh-TW")?new Error("手機格式錯誤"):!0},trigger:["input","blur"]}},D={originalPassword:{required:!0,validator(n,e){if(e)if(e.length>=4&&e.length<=20){if(!/^[A-Za-z0-9]+$/.test(e))return new Error("密碼僅能為大寫、小寫英文字母及數字")}else return new Error("密碼必須為 4 ~ 20 個字");else return new Error("請輸入密碼");return!0},trigger:["input","blur"]},newPassword:{required:!0,validator(n,e){return e&&!/^[A-Za-z0-9]+$/.test(e)?new Error("密碼僅能為大寫、小寫英文字母及數字"):e&&!(e.length>=4&&e.length<=20)?new Error("密碼必須為 4 ~ 20 個字"):!0},trigger:["input","blur"]},passwordConfirm:{required:!0,validator(n,e){return o.newPassword&&e!==o.newPassword?new Error("兩次密碼不一致"):!0},trigger:["input","blur"]}},E=async()=>{const n=await w.get("/users/me");Object.assign(o,n.data.result),Object.assign(i,{originalPassword:"",newPassword:"",passwordConfirm:""})},V=async()=>{var n;(n=C.value)==null||n.validate(async e=>{var s,u;if(e)P.error("請檢查資料是否完整");else{c.value=!0;try{await w.patch("/users/password/"+o._id,i),m.success({title:"成功",content:"密碼修改成功",positiveText:"確認"}),Object.assign(i,{originalPassword:"",newPassword:"",passwordConfirm:""})}catch(r){m.error({title:"失敗",content:((u=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:u.message)||"發生錯誤",positiveText:"確認"})}c.value=!1}})},j=async()=>{var n;(n=x.value)==null||n.validate(async e=>{var s,u;if(e)P.error("請檢查資料是否完整");else{c.value=!0;try{await w.patch("/users/"+o._id,o),m.success({title:"成功",content:"會員資料修改成功",positiveText:"確認"})}catch(r){m.error({title:"失敗",content:((u=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:u.message)||"發生錯誤",positiveText:"確認"})}c.value=!1}})},z=v([{type:"expand",renderExpand:n=>{const e=[];for(const s of n.products)e.push({name:s.p_id.name,price:s.p_id.price,quantity:s.quantity,productsTotalPrice:s.p_id.price*s.quantity});return I(T,{size:"small",columns:[{title:"商品名稱",key:"name"},{title:"單價",key:"price"},{title:"數量",key:"quantity"},{title:"商品金額",key:"productsTotalPrice"}],data:e},{})}},{title:"訂單編號",key:"_id"},{title:"日期",key:"date"},{title:"訂單金額",key:"totalPrice"}]);return W(()=>{R.from(".container",{opacity:0,duration:1})}),(n,e)=>{const s=X,u=$,r=Y,d=A,p=ee,f=G,U=H,g=ae,y=L,B=S;return Z(),F("div",te,[h("div",se,[a(s,{class:"pageTitle"},{default:t(()=>[_(" 會員中心 ")]),_:1}),a(u),a(r,null,{default:t(()=>[_("Hello "+Q(o.account)+"！",1)]),_:1}),a(B,{type:"segment"},{default:t(()=>[a(y,{name:"chap1",tab:"會員資料"},{default:t(()=>[a(U,{ref_key:"formRef",ref:x,model:o,rules:q},{default:t(()=>[a(f,{cols:12,"x-gap":24},{default:t(()=>[a(p,{span:6,label:"Name",path:"name"},{default:t(()=>[a(d,{value:o.name,"onUpdate:value":e[0]||(e[0]=l=>o.name=l),placeholder:"請輸入真實姓名，以免影響收貨權益"},null,8,["value"])]),_:1}),a(p,{span:6,label:"Eamil",path:"email"},{default:t(()=>[a(d,{value:o.email,"onUpdate:value":e[1]||(e[1]=l=>o.email=l),placeholder:"請輸入電子信箱"},null,8,["value"])]),_:1}),a(p,{span:6,label:"Phone",path:"mobilephone"},{default:t(()=>[a(d,{value:o.mobilephone,"onUpdate:value":e[2]||(e[2]=l=>o.mobilephone=l),placeholder:"請輸入手機"},null,8,["value"])]),_:1}),a(p,{span:6,label:"Address",path:"address"},{default:t(()=>[a(d,{value:o.address,"onUpdate:value":e[3]||(e[3]=l=>o.address=l),placeholder:"請輸入地址"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["model"]),h("div",ne,[a(g,{onClick:E},{default:t(()=>[_(" 取消 ")]),_:1}),a(g,{loading:c.value,type:"primary",onClick:j},{default:t(()=>[_(" 修改 ")]),_:1},8,["loading"])])]),_:1}),a(y,{name:"chap2",tab:"歷史訂單"},{default:t(()=>[a(J(T),{size:"large",columns:z,data:k,"default-expand-all":""},null,8,["columns","data"])]),_:1}),a(y,{name:"chap3",tab:"修改密碼"},{default:t(()=>[a(U,{ref_key:"passwordmRef",ref:C,model:i,rules:D},{default:t(()=>[a(f,{cols:12,"x-gap":24},{default:t(()=>[a(p,{span:12,label:"Password",path:"originalPassword"},{default:t(()=>[a(d,{value:i.originalPassword,"onUpdate:value":e[4]||(e[4]=l=>i.originalPassword=l),type:"password",placeholder:"請輸入原密碼"},null,8,["value"])]),_:1}),a(p,{span:12,label:"New Password",path:"newPassword"},{default:t(()=>[a(d,{value:i.newPassword,"onUpdate:value":e[5]||(e[5]=l=>i.newPassword=l),type:"password",placeholder:"請輸入新密碼"},null,8,["value"])]),_:1}),a(p,{span:12,label:"Confirm New Password",path:"passwordConfirm"},{default:t(()=>[a(d,{value:i.passwordConfirm,"onUpdate:value":e[6]||(e[6]=l=>i.passwordConfirm=l),type:"password",placeholder:"請再次輸入新密碼"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["model"]),h("div",oe,[a(g,{onClick:E},{default:t(()=>[_(" 取消 ")]),_:1}),a(g,{loading:c.value,type:"primary",onClick:V},{default:t(()=>[_(" 修改 ")]),_:1},8,["loading"])])]),_:1})]),_:1})])])}}},ge=K(re,[["__scopeId","data-v-496b64b8"]]);export{ge as default};
